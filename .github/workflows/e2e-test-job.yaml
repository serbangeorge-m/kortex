#
# Copyright (C) 2026 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: E2E Test Job

on:
  workflow_call:
    inputs:
      instance:
        description: 'GitHub Actions runner instance (e.g., macos-latest, windows-2025, ubuntu-24.04)'
        required: true
        type: string
      mode:
        description: 'Test mode (prod or dev)'
        required: true
        type: string
      compile_args:
        description: 'Arguments for pnpm compile:current (e.g., --win dir, --linux dir, --mac dir)'
        required: true
        type: string

jobs:
  e2e-test:
    name: ${{ inputs.instance }}
    runs-on: ${{ inputs.instance }}
    timeout-minutes: 60
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GEMINI_API_KEY: ${{ !startsWith(inputs.instance, 'ubuntu') && secrets.GEMINI_API_KEY || '' }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Execute pnpm
        run: pnpm install

      - name: Setup Ollama
        if: runner.os == 'Linux'
        uses: ai-action/setup-ollama@7c1d2c2a6e6c4f1909bf1d099acda773ca36401d # v1

      - name: Cache Ollama models
        if: runner.os == 'Linux'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        id: ollama-cache
        with:
          path: ~/.ollama/models
          key: ollama-gemma3-1b-${{ runner.os }}

      - name: Pull Ollama model
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # Wait for Ollama server to be ready (up to 60 seconds)
          for i in {1..30}; do
            if ollama list &> /dev/null; then
              echo "Ollama server is ready"
              break
            fi
            echo "Waiting for Ollama server... (attempt $i/30)"
            sleep 2
            if [ "$i" -eq 30 ]; then
              echo "Ollama server failed to start"
              exit 1
            fi
          done

          # Check if model is already cached and available
          if ollama list | grep -q gemma3:1b; then
            echo "Model gemma3:1b is already available (from cache)"
            echo "OLLAMA_ENABLED=true" >> "$GITHUB_ENV"
            exit 0
          fi

          # Pull the model with retries (digest mismatch is a known Ollama issue)
          for attempt in {1..5}; do
            echo "Pulling gemma3:1b model (attempt $attempt/5)..."
            ollama rm gemma3:1b 2>/dev/null || true
            
            if ollama pull gemma3:1b 2>&1 && ollama list | grep -q gemma3:1b; then
              echo "Model gemma3:1b is ready"
              echo "OLLAMA_ENABLED=true" >> "$GITHUB_ENV"
              exit 0
            fi
            
            wait_time=$((attempt * 10))
            echo "Pull failed, retrying in ${wait_time} seconds..."
            sleep $wait_time
          done

          echo "::warning::Failed to pull gemma3:1b model after 5 attempts - Ollama tests will be skipped"

      - name: Run Smoke E2E tests in ${{ inputs.mode == 'prod' && 'Production' || 'Development' }} Mode
        shell: bash
        run: |
          # Derive binary path from instance (OS and architecture)
          INSTANCE="${{ inputs.instance }}"
          if [[ "$INSTANCE" == *"windows"* ]]; then
            if [[ "$INSTANCE" == *"arm"* ]]; then
              BINARY_PATH="./dist/win-arm64-unpacked/Kortex.exe"
            else
              BINARY_PATH="./dist/win-unpacked/Kortex.exe"
            fi
          elif [[ "$INSTANCE" == *"ubuntu"* ]] || [[ "$INSTANCE" == *"linux"* ]]; then
            BINARY_PATH="./dist/linux-unpacked/kortex"
          elif [[ "$INSTANCE" == *"macos"* ]]; then
            if [[ "$INSTANCE" == *"intel"* ]]; then
              BINARY_PATH="./dist/mac/Kortex.app/Contents/MacOS/Kortex"
            else
              BINARY_PATH="./dist/mac-arm64/Kortex.app/Contents/MacOS/Kortex"
            fi
          else
            echo "::error::Unknown instance: $INSTANCE. Cannot determine binary path."
            exit 1
          fi
          
          if [ "${{ inputs.mode }}" == "prod" ]; then
            echo "Compiling Kortex in production mode"
            export ELECTRON_ENABLE_INSPECT=true
            pnpm compile:current ${{ inputs.compile_args }}
            
            path=$(realpath "$BINARY_PATH")
            echo "Kortex built binary: $path"
            export KORTEX_BINARY="$path"
          fi
          pnpm test:e2e

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@3585e9575db828022551b4231f165eb59a0e74e3 # v5
        if: always()
        with:
          annotate_only: true
          fail_on_failure: true
          include_passed: true
          detailed_summary: true
          require_tests: true
          report_paths: '**/*results.xml'

      - name: Upload test artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: results-e2e-${{ inputs.instance }}-${{ inputs.mode }}
          path: tests/playwright/output/**
          retention-days: 7
